{"version":3,"names":[],"mappings":"","sources":["ng-superlogin.js"],"sourcesContent":["/**\n * @license ng-superlogin v0.2.1\n * (c) 2015 Colin Skow\n * License: MIT\n */\n(function(angular) {\n'use strict';\n/* global angular */\n/* jshint -W097 */\n\nangular.module('superlogin', [])\n\n  .config([\"$httpProvider\", function($httpProvider) {\n    $httpProvider.interceptors.push('superloginInterceptor');\n  }])\n\n  .factory('slDateNow', function() {\n    return function(){\n      return Date.now();\n    };\n  })\n\n  .provider('superloginSession', [\"$windowProvider\", function($windowProvider) {\n    var $window = $windowProvider.$get();\n    var _config, _session, _refreshCB, _refreshInProgress;\n    var self = this;\n\n    this.configure = function(config) {\n      config = config || {};\n      config.baseUrl = config.baseUrl || '/auth/';\n      if(!config.endpoints || !(config.endpoints instanceof Array)) {\n        config.endpoints = [];\n      }\n      if(!config.noDefaultEndpoint) {\n        var parser = $window.document.createElement('a');\n        parser.href = '/';\n        config.endpoints.push(parser.host);\n      }\n      config.providers = config.providers || [];\n      _config = config;\n    };\n\n    this.$get = [\"$window\", \"$rootScope\", \"slDateNow\", function($window, $rootScope, slDateNow) {\n      // Apply defaults if there is no config\n      if(!_config) {\n        self.configure({});\n      }\n      var storage;\n      if(_config.storage === 'session') {\n        storage = $window.sessionStorage;\n      } else {\n       storage = $window.localStorage;\n      }\n      $rootScope.superlogin = {};\n\n      // Login and logout handlers\n      $rootScope.$on('sl:login', function(event, session) {\n        $rootScope.superlogin.session = session;\n        $rootScope.superlogin.authenticated = true;\n      });\n      $rootScope.$on('sl:logout', function() {\n        $rootScope.superlogin.session = null;\n        $rootScope.superlogin.authenticated = false;\n      });\n\n      // Setup the new session\n      _session = JSON.parse(storage.getItem('superlogin.session'));\n      if(_session) {\n        $rootScope.$broadcast('sl:login', _session);\n      }\n\n      function deleteSession() {\n        storage.removeItem('superlogin.session');\n        _session = null;\n      }\n\n      function checkExpired() {\n        // This is not necessary if we are not authenticated\n        if(!_session || !_session.user_id) {\n          return;\n        }\n        var expires = _session.expires;\n        var timeDiff = _session.serverTimeDiff || 0;\n        // Only compensate for time difference if it is greater than 5 seconds\n        if(Math.abs(timeDiff) < 5000) {\n          timeDiff = 0;\n        }\n        var estimatedServerTime = slDateNow() + timeDiff;\n        if(estimatedServerTime > expires) {\n          deleteSession();\n          $rootScope.$broadcast('sl:logout', 'Session expired');\n        }\n      }\n\n      // Check expired\n      if(_config.checkExpired === 'startup' || _config.checkExpired === 'stateChange') {\n        checkExpired();\n      }\n      if(_config.checkExpired === 'stateChange') {\n        // Events for both Angular Router and UI Router\n        $rootScope.$on('$routeChangeStart', function() {\n          checkExpired();\n        });\n        $rootScope.$on('$stateChangeStart', function() {\n          checkExpired();\n        });\n      }\n\n      return {\n        authenticated: function() {\n          return !!(_session && _session.user_id);\n        },\n        getSession: function() {\n          return _session || JSON.parse(storage.getItem('superlogin.session'));\n        },\n        setSession: function(session) {\n          _session = session;\n          storage.setItem('superlogin.session', JSON.stringify(_session));\n        },\n        deleteSession: deleteSession,\n        getConfig: function() {\n          return _config;\n        },\n        getDbUrl: function(dbName) {\n          if(_session.userDBs && _session.userDBs[dbName]) {\n            return _session.userDBs[dbName];\n          } else {\n            return null;\n          }\n        },\n        confirmRole: function(role) {\n          if (!_session || !_session.roles || !_session.roles.length) return false;\n          return _session.roles.indexOf(role) !== -1;\n        },\n        confirmAnyRole: function(roles) {\n          if (!_session || !_session.roles || !_session.roles.length) return false;\n          for (var i = 0; i < roles.length; i++) {\n            if (_session.roles.indexOf(roles[i]) !== -1) return true;\n          }\n        },\n        confirmAllRoles: function(roles) {\n          if (!_session || !_session.roles || !_session.roles.length) return false;\n          for (var i = 0; i < roles.length; i++) {\n            if (_session.roles.indexOf(roles[i]) === -1) return false;\n          }\n          return true;\n        },\n        checkExpired: checkExpired,\n        checkRefresh: function() {\n          // Get out if we are not authenticated or a refresh is already in progress\n          if(_refreshInProgress || (!_session || !_session.user_id)) {\n            return;\n          }\n          var issued = _session.issued;\n          var expires = _session.expires;\n          var threshold = _config.refreshThreshold || 0.5;\n          var duration = expires - issued;\n          var timeDiff = _session.serverTimeDiff || 0;\n          if(Math.abs(timeDiff) < 5000) {\n            timeDiff = 0;\n          }\n          var estimatedServerTime = slDateNow() + timeDiff;\n          var elapsed = estimatedServerTime - issued;\n          var ratio = elapsed / duration;\n          if((ratio > threshold) && (typeof _refreshCB === 'function')) {\n            _refreshInProgress = true;\n            _refreshCB()\n              .then(function() {\n                _refreshInProgress = false;\n              }, function() {\n                _refreshInProgress = false;\n              });\n          }\n        },\n        onRefresh: function(cb) {\n          _refreshCB = cb;\n        }\n      };\n    }];\n\n  }])\n\n  .provider('superlogin', [\"superloginSessionProvider\", function(superloginSessionProvider) {\n\n    this.configure = superloginSessionProvider.configure;\n\n    this.$get = [\"$http\", \"$q\", \"$window\", \"$interval\", \"$rootScope\", \"superloginSession\", \"slDateNow\", function($http, $q, $window, $interval, $rootScope, superloginSession, slDateNow) {\n\n      var oauthDeferred, oauthComplete;\n\n      $window.superlogin = {};\n      $window.superlogin.oauthSession = function(error, session, link) {\n        if(!error && session) {\n          session.serverTimeDiff = session.issued - slDateNow();\n          superloginSession.setSession(session);\n          $rootScope.$broadcast('sl:login', session);\n          oauthDeferred.resolve(session);\n        } else if(!error && link) {\n          $rootScope.$broadcast('sl:link', link);\n          oauthDeferred.resolve(capitalizeFirstLetter(link) + ' successfully linked.');\n        } else {\n          oauthDeferred.reject(error);\n        }\n        oauthComplete = true;\n        $rootScope.$apply();\n      };\n\n      superloginSession.onRefresh(refresh);\n\n      return {\n        authenticated: superloginSession.authenticated,\n        getConfig: superloginSession.getConfig,\n        getSession: superloginSession.getSession,\n        deleteSession: superloginSession.deleteSession,\n        getDbUrl: superloginSession.getDbUrl,\n        confirmRole: superloginSession.confirmRole,\n        confirmAnyRole: superloginSession.confirmAnyRole,\n        confirmAllRoles: superloginSession.confirmAllRoles,\n        refresh: refresh,\n        checkRefresh: superloginSession.checkRefresh,\n        checkExpired: superloginSession.checkExpired,\n        authenticate: function() {\n          var deferred = $q.defer();\n          var session = superloginSession.getSession;\n          if(session) {\n            deferred.resolve(session);\n          } else {\n            $rootScope.$on('sl:login', function(event, newSession) {\n              deferred.resolve(newSession);\n            });\n          }\n          return deferred.promise;\n        },\n        login: function(credentials) {\n          if(!credentials.username || !credentials.password) {\n            return $q.reject('Username or Password missing...');\n          }\n          var req = {\n            method: 'POST',\n            url: superloginSession.getConfig().baseUrl + 'login',\n            data: credentials\n          };\n          return $http(req)\n            .then(function(res) {\n              res.data.serverTimeDiff = res.data.issued - slDateNow();\n              superloginSession.setSession(res.data);\n              $rootScope.$broadcast('sl:login', res.data);\n              return $q.when(res.data);\n            }, function(err) {\n              superloginSession.deleteSession();\n              return $q.reject(err.data);\n            });\n        },\n        register: function(registration) {\n          var req = {\n            method: 'POST',\n            url: superloginSession.getConfig().baseUrl + 'register',\n            data: registration\n          };\n          return $http(req)\n            .then(function(res) {\n              if(res.data.user_id && res.data.token) {\n                res.data.serverTimeDiff = res.data.issued - slDateNow();\n                superloginSession.setSession(res.data);\n                $rootScope.$broadcast('sl:login', res.data);\n              }\n              return $q.when(res.data);\n            }, function(err) {\n              return $q.reject(err.data);\n            });\n        },\n        logout: function(msg) {\n          return $http.post(superloginSession.getConfig().baseUrl + 'logout', {})\n            .then(function(res) {\n              superloginSession.deleteSession();\n              $rootScope.$broadcast('sl:logout', msg || 'Logged out');\n              return $q.when(res.data);\n            }, function(err) {\n              superloginSession.deleteSession();\n              $rootScope.$broadcast('sl:logout', msg || 'Logged out');\n              return $q.reject(err.data);\n            });\n        },\n        logoutAll: function(msg) {\n          return $http.post(superloginSession.getConfig().baseUrl + 'logout-all', {})\n            .then(function(res) {\n              superloginSession.deleteSession();\n              $rootScope.$broadcast('sl:logout', msg || 'Logged out');\n              return $q.when(res.data);\n            }, function(err) {\n              superloginSession.deleteSession();\n              $rootScope.$broadcast('sl:logout', msg || 'Logged out');\n              return $q.when(err.data);\n            });\n        },\n        logoutOthers: function() {\n          return $http.post(superloginSession.getConfig().baseUrl + 'logout-others', {})\n            .then(function(res) {\n              return $q.when(res.data);\n            }, function(err) {\n              return $q.reject(err.data);\n            });\n        },\n        socialAuth: function(provider) {\n          var providers = superloginSession.getConfig().providers;\n          if(providers.indexOf(provider) === -1) {\n            return $q.reject({error: 'Provider ' + provider + ' not supported.'});\n          }\n          return oAuthPopup(superloginSession.getConfig().baseUrl + provider, {windowTitle: 'Login with ' + capitalizeFirstLetter(provider)});\n        },\n        tokenSocialAuth: function(provider, accessToken) {\n          var providers = superloginSession.getConfig().providers;\n          if(providers.indexOf(provider) === -1) {\n            return $q.reject({error: 'Provider ' + provider + ' not supported.'});\n          }\n          return $http.post(superloginSession.getConfig().baseUrl + provider + '/token', {access_token: accessToken})\n            .then(function(res) {\n              if(res.data.user_id && res.data.token) {\n                res.data.serverTimeDiff = res.data.issued - slDateNow();\n                superloginSession.setSession(res.data);\n                $rootScope.$broadcast('sl:login', res.data);\n              }\n              return $q.when(res.data);\n            }, function(err) {\n              return $q.reject(err.data);\n            });\n        },\n        tokenLink: function(provider, accessToken) {\n          var providers = superloginSession.getConfig().providers;\n          if(providers.indexOf(provider) === -1) {\n            return $q.reject({error: 'Provider ' + provider + ' not supported.'});\n          }\n          return $http.post(superloginSession.getConfig().baseUrl + 'link/' + provider + '/token', {access_token: accessToken})\n            .then(function(res) {\n              return $q.when(res.data);\n            }, function(err) {\n              return $q.reject(err.data);\n            });\n        },\n        link: function(provider) {\n          var providers = superloginSession.getConfig().providers;\n          if(providers.indexOf(provider) === -1) {\n            return $q.reject({error: 'Provider ' + provider + ' not supported.'});\n          }\n          if(superloginSession.authenticated()) {\n            var session = superloginSession.getSession();\n            var linkURL = superloginSession.getConfig().baseUrl + 'link/' + provider + '?bearer_token=' + session.token + ':' + session.password;\n            return oAuthPopup(linkURL, {windowTitle: 'Link your account to ' + capitalizeFirstLetter(provider)});\n          }\n          return $q.reject({error: 'Authentication required'});\n        },\n        unlink: function(provider) {\n          var providers = superloginSession.getConfig().providers;\n          if(providers.indexOf(provider) === -1) {\n            return $q.reject({error: 'Provider ' + provider + ' not supported.'});\n          }\n          if(superloginSession.authenticated()) {\n            return $http.post(superloginSession.getConfig().baseUrl + 'unlink/' + provider)\n              .then(function(res) {\n                return $q.when(res.data);\n              }, function(err) {\n                return $q.reject(err.data);\n              });\n          }\n          return $q.reject({error: 'Authentication required'});\n        },\n        verifyEmail: function(token) {\n          if(!token || typeof token !== 'string') {\n            return $q.reject({error: 'Invalid token'});\n          }\n          return $http.get(superloginSession.getConfig().baseUrl + 'verify-email/' + token)\n            .then(function(res) {\n              return $q.when(res.data);\n            }, function(err) {\n              return $q.reject(err.data);\n            });\n        },\n        forgotPassword: function(email) {\n          return $http.post(superloginSession.getConfig().baseUrl + 'forgot-password', {email: email})\n            .then(function(res) {\n              return $q.when(res.data);\n            }, function(err) {\n              return $q.reject(err.data);\n            });\n        },\n        resetPassword: function(form) {\n          return $http.post(superloginSession.getConfig().baseUrl + 'password-reset', form)\n            .then(function(res) {\n              if(res.data.user_id && res.data.token) {\n                superloginSession.setSession(res.data);\n                $rootScope.$broadcast('sl:login', res.data);\n              }\n              return $q.when(res.data);\n            }, function(err) {\n              return $q.reject(err.data);\n            });\n        },\n        changePassword: function(form) {\n          if(superloginSession.authenticated()) {\n            return $http.post(superloginSession.getConfig().baseUrl + 'password-change', form)\n              .then(function (res) {\n                return $q.when(res.data);\n              }, function (err) {\n                return $q.reject(err.data);\n              });\n          }\n          return $q.reject({error: 'Authentication required'});\n        },\n        changeEmail: function(newEmail) {\n          if(superloginSession.authenticated()) {\n            return $http.post(superloginSession.getConfig().baseUrl + 'change-email', {newEmail: newEmail})\n              .then(function (res) {\n                return $q.when(res.data);\n              }, function (err) {\n                return $q.reject(err.data);\n              });\n          }\n          return $q.reject({error: 'Authentication required'});\n        },\n        validateUsername: function(username) {\n          return $http.get(superloginSession.getConfig().baseUrl + 'validate-username/' + encodeURIComponent(username))\n            .then(function() {\n              return $q.when(true);\n            }, function(err) {\n              if(err.status === 409) {\n                return $q.reject(false);\n              }\n              return $q.reject(err.data);\n            });\n        },\n        validateEmail: function(email) {\n          return $http.get(superloginSession.getConfig().baseUrl + 'validate-email/' + encodeURIComponent(email))\n            .then(function () {\n              return $q.when(true);\n            }, function (err) {\n              if(err.status === 409) {\n                return $q.reject(false);\n              }\n              return $q.reject(err.data);\n            });\n        }\n      };\n\n      function refresh() {\n        var session = superloginSession.getSession();\n        return $http.post(superloginSession.getConfig().baseUrl + 'refresh', {})\n          .then(function(res) {\n            if(res.data.token && res.data.expires) {\n              session.expires = res.data.expires;\n              session.token = res.data.token;\n              superloginSession.setSession(session);\n              $rootScope.$broadcast('sl:refresh', session);\n              return $q.when(session);\n            }\n          }, function(err) {\n            return $q.reject(err.data);\n          });\n      }\n\n      function oAuthPopup(url, options) {\n        oauthDeferred = $q.defer();\n        oauthComplete = false;\n        options.windowName = options.windowName ||  'Social Login';\n        options.windowOptions = options.windowOptions || 'location=0,status=0,width=800,height=600';\n        var _oauthWindow = $window.open(url, options.windowName, options.windowOptions);\n        var _oauthInterval = $interval(function(){\n          if (_oauthWindow.closed) {\n            $interval.cancel(_oauthInterval);\n            if(!oauthComplete) {\n              oauthDeferred.reject('Authorization cancelled');\n              oauthComplete = true;\n            }\n          }\n        }, 500);\n        return oauthDeferred.promise;\n      }\n\n      // Capitalizes the first letter of a string\n      function capitalizeFirstLetter(string) {\n        return string.charAt(0).toUpperCase() + string.slice(1);\n      }\n\n    }];\n\n  }])\n\n  .service('superloginInterceptor', [\"$rootScope\", \"$q\", \"$window\", \"$location\", \"superloginSession\", function($rootScope, $q, $window, $location, superloginSession) {\n    var service = this;\n    var parser = $window.document.createElement('a');\n    var config = superloginSession.getConfig();\n    var endpoints = config.endpoints;\n\n    service.request = function(request) {\n      var session = superloginSession.getSession();\n      if(session && session.token) {\n        superloginSession.checkRefresh();\n      }\n      if(checkEndpoint(request.url, endpoints)) {\n        if(session && session.token) {\n          request.headers.Authorization = 'Bearer ' + session.token + ':' + session.password;\n        }\n      }\n      return request;\n    };\n\n    service.responseError = function(response) {\n      // If there is an unauthorized error from one of our endpoints and we are logged in...\n      if (checkEndpoint(response.config.url, endpoints) && response.status === 401 && superloginSession.authenticated()) {\n        superloginSession.deleteSession();\n        $rootScope.$broadcast('sl:logout', 'Session expired');\n      }\n      return $q.reject(response);\n    };\n\n    function checkEndpoint(url, endpoints) {\n      parser.href = url;\n      for(var i=0; i<endpoints.length; i++) {\n        if(parser.host === endpoints[i]) {\n          return true;\n        }\n      }\n      return false;\n    }\n\n  }]);\n})(angular);"],"file":"ng-superlogin.min.js","sourceRoot":"/source/"}