/**
 * @license ng-superlogin v0.2.2
 * (c) 2015 Colin Skow
 * License: MIT
 */
!function(e){"use strict";e.module("superlogin",[]).config(["$httpProvider",function(e){e.interceptors.push("superloginInterceptor")}]).factory("slDateNow",function(){return function(){return Date.now()}}).provider("superloginSession",["$windowProvider",function(e){var t,n,r,o,i=e.$get(),s=this;this.configure=function(e){if(e=e||{},e.baseUrl=e.baseUrl||"/auth/",e.endpoints&&e.endpoints instanceof Array||(e.endpoints=[]),!e.noDefaultEndpoint){var n=i.document.createElement("a");n.href="/",e.endpoints.push(n.host)}e.providers=e.providers||[],t=e},this.$get=["$window","$rootScope","slDateNow",function(e,i,a){function u(){d.removeItem("superlogin.session"),n=null}function c(){if(n&&n.user_id){var e=n.expires,t=n.serverTimeDiff||0;Math.abs(t)<5e3&&(t=0);var r=a()+t;r>e&&(u(),i.$broadcast("sl:logout","Session expired"))}}t||s.configure({});var d;return d="session"===t.storage?e.sessionStorage:e.localStorage,i.superlogin={},i.$on("sl:login",function(e,t){i.superlogin.session=t,i.superlogin.authenticated=!0}),i.$on("sl:logout",function(){i.superlogin.session=null,i.superlogin.authenticated=!1}),n=JSON.parse(d.getItem("superlogin.session")),n&&i.$broadcast("sl:login",n),"startup"!==t.checkExpired&&"stateChange"!==t.checkExpired||c(),"stateChange"===t.checkExpired&&(i.$on("$routeChangeStart",function(){c()}),i.$on("$stateChangeStart",function(){c()})),{authenticated:function(){return!(!n||!n.user_id)},getSession:function(){return n||JSON.parse(d.getItem("superlogin.session"))},setSession:function(e){n=e,d.setItem("superlogin.session",JSON.stringify(n))},deleteSession:u,getConfig:function(){return t},getDbUrl:function(e){return n.userDBs&&n.userDBs[e]?n.userDBs[e]:null},confirmRole:function(e){return n&&n.roles&&n.roles.length?-1!==n.roles.indexOf(e):!1},confirmAnyRole:function(e){if(!n||!n.roles||!n.roles.length)return!1;for(var t=0;t<e.length;t++)if(-1!==n.roles.indexOf(e[t]))return!0},confirmAllRoles:function(e){if(!n||!n.roles||!n.roles.length)return!1;for(var t=0;t<e.length;t++)if(-1===n.roles.indexOf(e[t]))return!1;return!0},checkExpired:c,checkRefresh:function(){if(!o&&n&&n.user_id){var e=n.issued,i=n.expires,s=t.refreshThreshold||.5,u=i-e,c=n.serverTimeDiff||0;Math.abs(c)<5e3&&(c=0);var d=a()+c,f=d-e,l=f/u;l>s&&"function"==typeof r&&(o=!0,r().then(function(){o=!1},function(){o=!1}))}},onRefresh:function(e){r=e}}}]}]).provider("superlogin",["superloginSessionProvider",function(e){this.configure=e.configure,this.$get=["$http","$q","$window","$interval","$rootScope","superloginSession","slDateNow",function(e,t,n,r,o,i,s){function a(){var n=i.getSession();return e.post(i.getConfig().baseUrl+"refresh",{}).then(function(e){return e.data.token&&e.data.expires?(n.expires=e.data.expires,n.token=e.data.token,i.setSession(n),o.$broadcast("sl:refresh",n),t.when(n)):void 0},function(e){return t.reject(e.data)})}function u(e,o){d=t.defer(),f=!1,o.windowName=o.windowName||"Social Login",o.windowOptions=o.windowOptions||"location=0,status=0,width=800,height=600";var i=n.open(e,o.windowName,o.windowOptions),s=r(function(){i.closed&&(r.cancel(s),f||(d.reject("Authorization cancelled"),f=!0))},500);return d.promise}function c(e){return e.charAt(0).toUpperCase()+e.slice(1)}var d,f;return n.superlogin={},n.superlogin.oauthSession=function(e,t,n){!e&&t?(t.serverTimeDiff=t.issued-s(),i.setSession(t),o.$broadcast("sl:login",t),d.resolve(t)):!e&&n?(o.$broadcast("sl:link",n),d.resolve(c(n)+" successfully linked.")):d.reject(e),f=!0,o.$apply()},i.onRefresh(a),{authenticated:i.authenticated,getConfig:i.getConfig,getSession:i.getSession,deleteSession:i.deleteSession,getDbUrl:i.getDbUrl,confirmRole:i.confirmRole,confirmAnyRole:i.confirmAnyRole,confirmAllRoles:i.confirmAllRoles,refresh:a,checkRefresh:i.checkRefresh,checkExpired:i.checkExpired,authenticate:function(){var e=t.defer(),n=i.getSession();return n?e.resolve(n):o.$on("sl:login",function(t,n){e.resolve(n)}),e.promise},login:function(n){if(!n.username||!n.password)return t.reject("Username or Password missing...");var r={method:"POST",url:i.getConfig().baseUrl+"login",data:n};return e(r).then(function(e){return e.data.serverTimeDiff=e.data.issued-s(),i.setSession(e.data),o.$broadcast("sl:login",e.data),t.when(e.data)},function(e){return i.deleteSession(),t.reject(e.data)})},register:function(n){var r={method:"POST",url:i.getConfig().baseUrl+"register",data:n};return e(r).then(function(e){return e.data.user_id&&e.data.token&&(e.data.serverTimeDiff=e.data.issued-s(),i.setSession(e.data),o.$broadcast("sl:login",e.data)),t.when(e.data)},function(e){return t.reject(e.data)})},logout:function(n){return e.post(i.getConfig().baseUrl+"logout",{}).then(function(e){return i.deleteSession(),o.$broadcast("sl:logout",n||"Logged out"),t.when(e.data)},function(e){return i.deleteSession(),o.$broadcast("sl:logout",n||"Logged out"),t.reject(e.data)})},logoutAll:function(n){return e.post(i.getConfig().baseUrl+"logout-all",{}).then(function(e){return i.deleteSession(),o.$broadcast("sl:logout",n||"Logged out"),t.when(e.data)},function(e){return i.deleteSession(),o.$broadcast("sl:logout",n||"Logged out"),t.when(e.data)})},logoutOthers:function(){return e.post(i.getConfig().baseUrl+"logout-others",{}).then(function(e){return t.when(e.data)},function(e){return t.reject(e.data)})},socialAuth:function(e){var n=i.getConfig().providers;return-1===n.indexOf(e)?t.reject({error:"Provider "+e+" not supported."}):u(i.getConfig().baseUrl+e,{windowTitle:"Login with "+c(e)})},tokenSocialAuth:function(n,r){var a=i.getConfig().providers;return-1===a.indexOf(n)?t.reject({error:"Provider "+n+" not supported."}):e.post(i.getConfig().baseUrl+n+"/token",{access_token:r}).then(function(e){return e.data.user_id&&e.data.token&&(e.data.serverTimeDiff=e.data.issued-s(),i.setSession(e.data),o.$broadcast("sl:login",e.data)),t.when(e.data)},function(e){return t.reject(e.data)})},tokenLink:function(n,r){var o=i.getConfig().providers;return-1===o.indexOf(n)?t.reject({error:"Provider "+n+" not supported."}):e.post(i.getConfig().baseUrl+"link/"+n+"/token",{access_token:r}).then(function(e){return t.when(e.data)},function(e){return t.reject(e.data)})},link:function(e){var n=i.getConfig().providers;if(-1===n.indexOf(e))return t.reject({error:"Provider "+e+" not supported."});if(i.authenticated()){var r=i.getSession(),o=i.getConfig().baseUrl+"link/"+e+"?bearer_token="+r.token+":"+r.password;return u(o,{windowTitle:"Link your account to "+c(e)})}return t.reject({error:"Authentication required"})},unlink:function(n){var r=i.getConfig().providers;return-1===r.indexOf(n)?t.reject({error:"Provider "+n+" not supported."}):i.authenticated()?e.post(i.getConfig().baseUrl+"unlink/"+n).then(function(e){return t.when(e.data)},function(e){return t.reject(e.data)}):t.reject({error:"Authentication required"})},verifyEmail:function(n){return n&&"string"==typeof n?e.get(i.getConfig().baseUrl+"verify-email/"+n).then(function(e){return t.when(e.data)},function(e){return t.reject(e.data)}):t.reject({error:"Invalid token"})},forgotPassword:function(n){return e.post(i.getConfig().baseUrl+"forgot-password",{email:n}).then(function(e){return t.when(e.data)},function(e){return t.reject(e.data)})},resetPassword:function(n){return e.post(i.getConfig().baseUrl+"password-reset",n).then(function(e){return e.data.user_id&&e.data.token&&(i.setSession(e.data),o.$broadcast("sl:login",e.data)),t.when(e.data)},function(e){return t.reject(e.data)})},changePassword:function(n){return i.authenticated()?e.post(i.getConfig().baseUrl+"password-change",n).then(function(e){return t.when(e.data)},function(e){return t.reject(e.data)}):t.reject({error:"Authentication required"})},changeEmail:function(n){return i.authenticated()?e.post(i.getConfig().baseUrl+"change-email",{newEmail:n}).then(function(e){return t.when(e.data)},function(e){return t.reject(e.data)}):t.reject({error:"Authentication required"})},validateUsername:function(n){return e.get(i.getConfig().baseUrl+"validate-username/"+encodeURIComponent(n)).then(function(){return t.when(!0)},function(e){return 409===e.status?t.reject(!1):t.reject(e.data)})},validateEmail:function(n){return e.get(i.getConfig().baseUrl+"validate-email/"+encodeURIComponent(n)).then(function(){return t.when(!0)},function(e){return 409===e.status?t.reject(!1):t.reject(e.data)})}}}]}]).service("superloginInterceptor",["$rootScope","$q","$window","$location","superloginSession",function(e,t,n,r,o){function i(e,t){a.href=e;for(var n=0;n<t.length;n++)if(a.host===t[n])return!0;return!1}var s=this,a=n.document.createElement("a"),u=o.getConfig(),c=u.endpoints;s.request=function(e){var t=o.getSession();return t&&t.token&&o.checkRefresh(),i(e.url,c)&&t&&t.token&&(e.headers.Authorization="Bearer "+t.token+":"+t.password),e},s.responseError=function(n){return i(n.config.url,c)&&401===n.status&&o.authenticated()&&(o.deleteSession(),e.$broadcast("sl:logout","Session expired")),t.reject(n)}}])}(angular);
//# sourceMappingURL=ng-superlogin.min.js.map
